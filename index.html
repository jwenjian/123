<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>123 木头人 | 鱿鱼游戏</title>
  <link rel="stylesheet" href="index.css">
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
</head>

<body>
  <div class="before-start">
    <img style="height: 50vh;" src="Girl.png" alt="" srcset="">
    <h1 class="shadow">123木头人</h1>
    <p>规则很简单：鬼说“123木头人”的时候往下滑动页面，鬼不说话不能动，否则就是死；5分钟内滑到底部算赢</p>
    <p>注意：按键盘就死</p>
    <p>注意：按鼠标中键也死</p>
    <p>注意：5分钟没完成也死</p>
    <p>点击下方【我同意】按钮开始游戏</p>
    <button id="agree">我同意</button>
  </div>
  <div class="game">
    <div class="playground"></div>
    <div class="success"></div>
    <p id="u">🤭</p>
    <div class="progress">
      <p class="info">当前进度： <b id="percernt">0%</b></p>
    </div>
  </div>

  <script>

    var started = false;
    var scrollY = 0
    const DISTANCE = 100000
    const TARGET = DISTANCE + window.innerHeight / 2
    var finished = false
    var startTime;
    var endTime;
    var duration;
    var canScroll = false;
    var gameInterval;
    var agreed = false;
    var dead = false
    var rate = 1

    var gameSound = new Howl({
      src: "game.m4a",
      onplay: e => {
        canScroll = true;
        console.log('runnnnnnnnnnnnnnnnnnn')
      },
      onend: e => {
        canScroll = false
        console.log('freeeeeeeeeeeeeeeze')
      }
    })

    function gamePlayStarted(e) {
      console.log('start')
      canScroll = true;
    }
    function gamePlayEnded(e) {
      console.log('end')
      canScroll = false;
    }

    function bang(msg) {

      if (dead) {
        return
      }

      dead = true
      let deadTime = Date.now()
      let duration = 0
      duration = Math.floor(deadTime - startTime) / 1000
      let result = `
      🔫 BANG!
      你死了！
      用时 ${duration} s
      前进了 ${Math.floor(100 * scrollY / TARGET)}%
      `
      clearInterval(gameInterval)
      console.log(result)
      alert(result)
      location.reload()
    }

    document.querySelector("#agree").addEventListener('click', e => {
      agreed = true
      startTime = Date.now()
      document.querySelector('#u').innerHTML = '😝'
      console.log('started')
      gameInterval = setInterval(() => {
        if (finished) {
          clearInterval(gameInterval)
          return
        }
        rate = rate + 0.2
        if (rate >= 3) {
          rate = 3
        }
        gameSound.rate(rate)
        gameSound.play()
      }, 6000);
      started = true
      document.querySelector('.game').classList.remove('hide')
      gameSound.play()
      document.querySelector('.progress').classList.remove('hide')
      setTimeout(() => {
        // 5 min
        if (dead) {
          return
        }
        if (!finished) {
          bang()
          return
        }
      }, 300000);
    })
    document.querySelector('.game').classList.add('hide')
    document.querySelector('.progress').classList.add('hide')

    document.addEventListener('keydown', e => {
      bang('no key down, you are dead')
      e.preventDefault()
    })
    document.addEventListener('mousedown', e => {
      if (e.button === 1) {
        e.preventDefault()
        bang()
        return
      }
     
    })
    document.addEventListener('scroll', e => {
      if (!agreed) {
        e.preventDefault()
        return
      }
      if (!started) {
        e.preventDefault();
        return
      }

      if (started) {
        if (finished) {
          return
        }
        if (!canScroll) {
          bang('木头人怎么能动呢？')
          return
        }
        scrollY = document.documentElement.scrollTop || document.body.scrollTop
        let progress = `${Math.floor(100 * scrollY / TARGET)}%`
        document.querySelector('#percernt').innerHTML = progress
        if (scrollY >= TARGET) {
          endTime = Date.now()
          duration = endTime - startTime
          console.log('passed')
          document.querySelector('#u').innerHTML = '🤭'
          clearInterval(gameInterval)
          finished = true
          alert('ok')
        } else if (scrollY > 0) {
          document.querySelector('#u').innerHTML = '😝'
        } else {
          started = false;
          document.querySelector('#u').innerHTML = '🤭'
          clearInterval(gameInterval)
        }
      }


    })


  </script>
</body>

</html>